{% extends 'base.html' %}

{% block content %}
<!-- Highlight.js (VS Code Dark) & Marked.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


<style>
    /* Toggle Switch Styles */
    .note-toggle-container {
        display: flex;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 4px;
        gap: 5px;
    }

    .note-toggle-btn {
        flex: 1;
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        background: transparent;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.2s;
    }

    .note-toggle-btn.active {
        background: var(--card-bg);
        color: var(--text-primary);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Editor Container */
    .notion-editor {
        min-height: 400px;
        max-height: 75vh;
        overflow-y: auto;
        padding: 40px;
        background: var(--bg-primary);
        color: #ffffff;
        caret-color: white;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        outline: none;
        font-size: 16px;
        line-height: 1.6;
        white-space: pre-wrap;
        display: none;
        /* Hidden by default */
    }

    .notion-editor.active-editor {
        display: block;
    }

    .notion-editor:empty:before {
        content: attr(placeholder);
        color: var(--text-secondary);
    }

    /* Headings White */
    .notion-editor h1,
    .notion-editor h2,
    .notion-editor h3,
    .notion-editor h4,
    .notion-editor h5,
    .notion-editor h6 {
        margin-top: 1.5em;
        margin-bottom: 0.5em;
        color: #ffffff !important;
    }

    /* General Text White - Be careful not to override Code colors */
    .notion-editor p,
    .notion-editor div,
    .notion-editor li,
    .notion-editor strong,
    .notion-editor b {
        color: #ffffff !important;
    }

    .notion-editor p {
        margin-bottom: 1em;
    }

    .notion-editor ul,
    .notion-editor ol {
        margin-left: 20px;
    }

    .notion-editor blockquote {
        border-left: 3px solid var(--text-primary);
        padding-left: 14px;
        color: #cccccc;
    }

    /* --- CODE BLOCK STYLING (VS Code) --- */
    .notion-editor pre {
        background: #1E1E1E !important;
        /* VS Code Background */
        border-radius: 6px;
        padding: 1em;
        margin: 1em 0;
        overflow-x: auto;
        border: 1px solid #333;
    }

    .notion-editor pre code {
        background: transparent !important;
        padding: 0;
        border-radius: 0;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.9em;
        /* Do NOT set color here, let highlight.js set it */
    }

    /* --- INLINE CODE STYLING --- */
    /* Target code tags that are NOT inside pre */
    .notion-editor :not(pre)>code {
        background: #2D2D2D !important;
        /* Visible Grey Background */
        color: #E06C75 !important;
        /* Reddish/Pinkish text (VS Code-ish) */
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-family: monospace;
        /* Ensure it overrides the 'white' text rule */
    }

    .notion-editor img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
        margin: 10px 0;
        cursor: pointer;
    }

    /* --- MATHJAX OPTIMIZATION --- */
    /* Force MathJax to respect container bounds and font size */
    .notion-editor mjx-container {
        font-size: 110% !important;
        /* Slight boost but not giant */
        overflow-x: auto;
        overflow-y: hidden;
        max-width: 100%;
        vertical-align: middle;
    }

    .notion-editor mjx-container svg {
        max-width: 100%;
        height: auto;
    }

    /* Reset any massive inline headers people might paste */
    .notion-editor h1 {
        font-size: 1.8em !important;
    }

    .notion-editor h2 {
        font-size: 1.5em !important;
    }

    .notion-editor h3 {
        font-size: 1.3em !important;
    }

    /* --- FLOATING TOOLBAR --- */
    #floating-toolbar {
        position: absolute;
        z-index: 1000;
        background: #333;
        border-radius: 4px;
        padding: 5px;
        display: none;
        /* Hidden by default */
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        gap: 5px;
    }

    #floating-toolbar button {
        background: transparent;
        border: none;
        color: white;
        cursor: pointer;
        padding: 5px 10px;
        font-size: 0.9em;
        border-radius: 3px;
        font-weight: 600;
    }

    #floating-toolbar button:hover {
        background: #444;
    }

    #floating-toolbar::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #333 transparent transparent transparent;
    }
</style>

<div style="display: flex; justify-content: space-between; align-items: center;">
    <!-- Floating Toolbar Element -->
    <div id="floating-toolbar">
        <button id="btn-mark-code">Code &lt;/&gt;</button>
    </div>
    <div>
        <a href="{% url 'exam_detail' subject.exam.id %}" style="color: #666;">‚Üê Back to {{ subject.exam.name }}</a>
        <h1>{{ subject.name }}</h1>
    </div>
    <div style="display: flex; align-items: center; gap: 20px;">
        <div
            style="background: var(--bg-secondary); padding: 8px 15px; border-radius: 8px; font-size: 0.9em; display: flex; gap: 15px; align-items: center; border: 1px solid var(--border-color);">
            <!-- New Hours Metrics -->
            <div>
                <strong>{{ watched_hours }} hrs</strong> watched
                <span style="color: var(--text-secondary); margin: 0 5px;">|</span>
                <strong>{{ left_hours }} hrs</strong> left
            </div>
        </div>

        <div class="progress-circle" style="--progress: {{ progress }}deg; width: 60px; height: 60px;">
            <div class="progress-inner" style="width: 50px; height: 50px; font-size: 12px;">
                {{ completed }} / {{ total }}
            </div>
        </div>
    </div>
</div>

{% if videos|length == 0 %}
<div class="card" style="margin-bottom: 20px; background: #fff8c4;">
    <h3>Import Playlist</h3>
    <form action="{% url 'add_playlist' subject.id %}" method="post">
        {% csrf_token %}
        <input type="text" name="playlist_url" placeholder="Paste YouTube Playlist URL" required>
        <button type="submit" class="btn btn-primary" style="margin-top: 10px;">Import Videos</button>
    </form>
</div>
{% endif %}

<!-- View Toggle -->
<div class="view-toggle-container">
    <button class="view-toggle-btn active" id="toggle-checklist" onclick="switchMainView('checklist')">
        üìπ Video Checklist
    </button>
    <button class="view-toggle-btn" id="toggle-notes" onclick="switchMainView('notes')">
        üìù Notes
    </button>
</div>

<!-- Video Checklist View -->
<div id="view-checklist" class="full-width-section">
    {% if videos|length > 0 %}
    <div style="text-align: right; margin-bottom: 10px;">
        <button onclick="confirmDelete('{% url 'delete_playlist' subject.id %}', 'Playlist')" class="btn"
            style="background: transparent; color: #e74c3c; border: 1px solid #e74c3c; padding: 5px 10px; font-size: 0.8em;"
            title="Delete All Videos">üóëÔ∏è Delete Playlist</button>
    </div>
    {% endif %}
    <table>
        <thead>
            <tr>
                <th style="width: 50px;">#</th>
                <th>Title</th>
                <th style="width: 100px;">Duration</th>
                <th style="width: 150px;">Action</th>
                <th style="width: 50px;">Done</th>
            </tr>
        </thead>
        <tbody>
            {% for video in videos %}
            <tr class="{% if video.is_watched %}watched{% endif %}">
                <td>{{ forloop.counter }}</td>
                <td>{{ video.title }}</td>
                <td style="color: #666; font-size: 0.9em;">{{ video.duration_display }}</td>
                <td>
                    <a href="https://www.youtube.com/watch?v={{ video.video_id }}" target="_blank"
                        class="btn btn-sm btn-primary btn-youtube">Watch</a>
                </td>
                <td>
                    <input type="checkbox" onchange="toggleWatched('{{ video.id }}', this)" {% if video.is_watched %}checked{% endif %}>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Notes View -->
<div id="view-notes" class="full-width-section" style="display: none;">
    <div class="notes-container">
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center;">
            <div class="note-toggle-container">
                <button id="btn-content" class="note-toggle-btn active" onclick="switchNoteType('content')">ChatGPT
                    Response</button>
                <button id="btn-screenshots" class="note-toggle-btn" onclick="switchNoteType('screenshots')">Lecture
                    Screenshots</button>
            </div>

            <div style="display:flex; gap:10px;">
                <select id="fontSizeSelect" class="btn" onchange="changeFontSize(this.value)"
                    style="padding: 2px 10px; cursor: pointer;">
                    <option value="" disabled selected>Size</option>
                    <option value="12px">12px</option>
                    <option value="14px">14px</option>
                    <option value="16px">16px</option>
                    <option value="18px">18px</option>
                </select>

                <button class="btn" onclick="downloadPDF()">Export PDF</button>
            </div>
        </div>

        <!-- Editable Divs (Double) -->
        <div id="editor-content" class="notion-editor active-editor" contenteditable="true"
            placeholder="Paste ChatGPT notes here (Supports Markdown Code Blocks)..."></div>

        <div id="editor-screenshots" class="notion-editor" contenteditable="true"
            placeholder="Paste lecture screenshots here..."></div>

        <div style="text-align: right; margin-top: 5px;">
            <button class="btn btn-primary" onclick="saveNotes()">Save Notes</button>
        </div>
    </div>
</div>

<script>
    console.log("===== SUBJECT_DETAIL.HTML SCRIPT LOADED =====");
    console.log("YT API available?", typeof YT !== 'undefined');

    const noteId = "{{ note.id }}";
    let activeNoteType = 'content'; // 'content' or 'screenshots'

    // Initial Load - Content Injection
    // Initial Load - Content Injection via Lazy Loading
    async function loadNoteContent(type) {
        const editorId = type === 'content' ? 'editor-content' : 'editor-screenshots';
        const editor = document.getElementById(editorId);
        editor.innerHTML = '<div style="color: #888; padding: 20px;">Loading notes...</div>';

        try {
            const response = await fetch(`/core/note/${noteId}/content/?type=${type}`);
            if (response.ok) {
                const text = await response.text();
                editor.innerHTML = text;

                // Re-highlight and Typeset
                if (window.MathJax) {
                    MathJax.typesetPromise([editor]).then(() => { });
                }
                editor.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });

                // --- Auto-Sanitize on Load ---
                setTimeout(() => sanitizeEditor(editor), 100);
            } else {
                editor.innerHTML = '';
            }
        } catch (error) {
            console.error('Error loading notes:', error);
            editor.innerHTML = '<div style="color: red; padding: 20px;">Error loading notes.</div>';
        }
    }

    loadNoteContent('content');
    loadNoteContent('screenshots');

    function highlightAll() {
        document.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
        });
    }
    highlightAll();

    function switchNoteType(type) {
        activeNoteType = type;
        document.querySelectorAll('.note-toggle-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-${type}`).classList.add('active');
        document.querySelectorAll('.notion-editor').forEach(ed => ed.classList.remove('active-editor'));
        document.getElementById(`editor-${type}`).classList.add('active-editor');
    }

    function saveNotes() {
        const editorFn = activeNoteType === 'content' ? 'editor-content' : 'editor-screenshots';
        const content = document.getElementById(editorFn).innerHTML;

        fetch(`/core/note/${noteId}/save/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                content: content,
                note_type: activeNoteType
            })
        }).then(() => {
            alert('Notes Saved!');
        });

    }

    // --- FLOATING TOOLBAR LOGIC ---
    const toolbar = document.getElementById('floating-toolbar');
    const markCodeBtn = document.getElementById('btn-mark-code');

    function updateToolbarPosition() {
        const selection = window.getSelection();
        if (selection.rangeCount === 0 || selection.isCollapsed) {
            toolbar.style.display = 'none';
            return;
        }

        const range = selection.getRangeAt(0);
        // Only show if selection is within an active editor
        const activeEditor = document.querySelector('.notion-editor.active-editor');
        if (!activeEditor || !activeEditor.contains(range.commonAncestorContainer)) {
            toolbar.style.display = 'none';
            return;
        }

        const rect = range.getBoundingClientRect();

        // Position above the selection
        toolbar.style.top = `${rect.top + window.scrollY - 40}px`;
        toolbar.style.left = `${rect.left + window.scrollX + (rect.width / 2) - (toolbar.offsetWidth / 2)}px`;
        toolbar.style.display = 'flex';
    }

    // specific events to trigger toolbar update
    document.addEventListener('mouseup', updateToolbarPosition);
    document.addEventListener('keyup', (e) => {
        if (e.key === 'Shift' || e.key.startsWith('Arrow')) {
            updateToolbarPosition();
        }
    });

    // Hide on click elsewhere
    document.addEventListener('mousedown', (e) => {
        if (!toolbar.contains(e.target)) {
            // Let the mouseup event handle showing it again if a new selection is made
            // But if we just click empty space, we want to hide it.
            // We'll rely on the fact that if a click clears selection, mouseup `selection.isCollapsed` will hide it.
        }
    });

    markCodeBtn.addEventListener('click', (e) => {
        e.preventDefault(); // Prevent losing focus
        const selection = window.getSelection();
        if (!selection.rangeCount) return;

        const range = selection.getRangeAt(0);
        const text = range.toString();

        if (text) {
            // Create the code block structure
            // Use <pre><code ...>...</code></pre>
            // We use a temporary container to facilitate insertion
            const pre = document.createElement('pre');
            const code = document.createElement('code');
            code.textContent = text; // Safely escape HTML
            pre.appendChild(code);

            range.deleteContents();
            range.insertNode(pre);

            // Highlight it immediately
            hljs.highlightElement(code);

            // Clean up: hide toolbar
            toolbar.style.display = 'none';
            window.getSelection().removeAllRanges();
        }
    });

    // --- Sanitize / Optimize Logic ---
    function sanitizeEditor(editor) {
        if (!editor) return;

        // 1. Strip unwanted inline styles from ALL elements
        editor.querySelectorAll('*').forEach(el => {
            // Remove fixed font sizes, especially giant ones or 'pt' values
            if (el.style.fontSize) {
                el.style.fontSize = '';
                el.removeAttribute('data-font-size'); // classic Notion/garbage attr
            }

            // Remove fixed backgrounds (often white from ChatGPT)
            if (el.style.backgroundColor) {
                el.style.backgroundColor = '';
            }

            // Remove fixed colors (often black text on dark mode)
            if (el.style.color) {
                el.style.color = '';
            }

            // Clean specific tags
            if (el.tagName === 'MJX-CONTAINER' || el.tagName === 'SVG') {
                el.style = ""; // Wipe all inline styles from MathJax
                el.setAttribute('style', '');
            }
        });

        // 2. Normalize Headings
        editor.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(h => {
            h.style.fontSize = ''; // Let CSS control it
        });
    }

    // Check & Highlight on Blur
    document.querySelectorAll('.notion-editor').forEach(editor => {
        editor.addEventListener('blur', function () {
            // Apply highlight to any PRE blocks that exist
            editor.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        });

        // Sanitize paste styles
        editor.addEventListener('paste', function (e) {
            // we'll rely on the timeout to clean up AFTER paste
            setTimeout(() => {
                sanitizeEditor(editor);
            }, 50); // Fast cleanup
        });
    });

    // --- Helper Functions ---
    if (window.MathJax) {
        MathJax.typesetPromise([document.getElementById('editor-content')]).then(() => { });
        MathJax.typesetPromise([document.getElementById('editor-screenshots')]).then(() => { });
    }

    function changeFontSize(size) {
        if (!size) return;
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0 || selection.isCollapsed) return;
        const span = document.createElement("span");
        span.style.fontSize = size;
        try {
            const range = selection.getRangeAt(0);
            const content = range.extractContents();
            span.appendChild(content);
            range.insertNode(span);
        } catch (e) { console.error(e); }
        document.getElementById('fontSizeSelect').selectedIndex = 0;
    }

    // Global reference for the player


    function toggleWatched(videoId, checkbox) {
        fetch(`/core/video/${videoId}/status/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ is_watched: checkbox.checked })
        }).then(r => r.json()).then(data => {
            if (data.today_minutes !== undefined) document.getElementById('today-minutes').innerText = data.today_minutes;
        });
    }

    /* UPDATED PDF EXPORT */
    function downloadPDF() {
        var printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>Notes Export</title>');

        // 1. Inject Highlight.js CSS for PDF
        printWindow.document.write('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">');

        printWindow.document.write('<style>');
        printWindow.document.write(`
            @media print {
                @page {
                    margin-bottom: 2cm;
                    @bottom-center {
                        content: "Page " counter(page);
                        font-size: 10pt;
                        color: #555;
                    }
                }
                body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                pre { background-color: #1E1E1E !important; color: #dcdcdc !important; }
            }
            body { font-family: sans-serif; padding: 40px; background: white; color: black; }
            /* Explicitly dark code blocks for print */
            pre { 
                background: #1E1E1E !important; 
                border-radius: 6px; 
                padding: 1em; 
                margin: 1em 0; 
                white-space: pre-wrap; 
                color: #dcdcdc;
            }
            code { font-family: monospace; }
            img { max-width:100%; }
        `);
        printWindow.document.write('</style>');

        printWindow.document.write('</head><body>');
        printWindow.document.write('<h1>{{ subject.name|escapejs }} Notes (' + (activeNoteType === 'content' ? 'Theory' : 'Screenshots') + ')</h1>');
        printWindow.document.write(document.querySelector('.notion-editor.active-editor').innerHTML);
        printWindow.document.write('</body></html>');
        printWindow.document.close();

        // Delay to allow CSS to load
        setTimeout(() => { printWindow.print(); }, 1500);
    }

    // View Switching Logic
    function switchMainView(viewName) {
        // Toggles
        document.querySelectorAll('.view-toggle-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`toggle-${viewName}`).classList.add('active');

        // Views
        const checklist = document.getElementById('view-checklist');
        const notes = document.getElementById('view-notes');

        if (viewName === 'checklist') {
            checklist.style.display = 'block';
            notes.style.display = 'none';
        } else {
            checklist.style.display = 'none';
            notes.style.display = 'block';
        }
    }
</script>
{% endblock %}