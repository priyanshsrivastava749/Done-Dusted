{% extends 'base.html' %}

{% block content %}
<!-- Highlight.js (VS Code Dark) & Marked.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


<style>
    /* Toggle Switch Styles */
    .note-toggle-container {
        display: flex;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 4px;
        gap: 5px;
    }

    .note-toggle-btn {
        flex: 1;
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        background: transparent;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.2s;
    }

    .note-toggle-btn.active {
        background: var(--card-bg);
        color: var(--text-primary);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Editor Container */
    .notion-editor {
        min-height: 400px;
        max-height: 75vh;
        overflow-y: auto;
        padding: 40px;
        background: var(--bg-primary);
        color: #ffffff;
        caret-color: white;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        outline: none;
        font-size: 16px;
        line-height: 1.6;
        white-space: pre-wrap;
        display: none;
        /* Hidden by default */
    }

    .notion-editor.active-editor {
        display: block;
    }

    .notion-editor:empty:before {
        content: attr(placeholder);
        color: var(--text-secondary);
    }

    /* Headings White */
    .notion-editor h1,
    .notion-editor h2,
    .notion-editor h3,
    .notion-editor h4,
    .notion-editor h5,
    .notion-editor h6 {
        margin-top: 1.5em;
        margin-bottom: 0.5em;
        color: #ffffff !important;
    }

    /* General Text White - Be careful not to override Code colors */
    .notion-editor p,
    .notion-editor div,
    .notion-editor li,
    .notion-editor strong,
    .notion-editor b {
        color: #ffffff !important;
    }

    .notion-editor p {
        margin-bottom: 1em;
    }

    .notion-editor ul,
    .notion-editor ol {
        margin-left: 20px;
    }

    .notion-editor blockquote {
        border-left: 3px solid var(--text-primary);
        padding-left: 14px;
        color: #cccccc;
    }

    /* --- CODE BLOCK STYLING (VS Code) --- */
    .notion-editor pre {
        background: #1E1E1E !important;
        /* VS Code Background */
        border-radius: 6px;
        padding: 1em;
        margin: 1em 0;
        overflow-x: auto;
        border: 1px solid #333;
    }

    .notion-editor pre code {
        background: transparent !important;
        padding: 0;
        border-radius: 0;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.9em;
        /* Do NOT set color here, let highlight.js set it */
    }

    /* --- INLINE CODE STYLING --- */
    /* Target code tags that are NOT inside pre */
    .notion-editor :not(pre)>code {
        background: #2D2D2D !important;
        /* Visible Grey Background */
        color: #E06C75 !important;
        /* Reddish/Pinkish text (VS Code-ish) */
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-family: monospace;
        /* Ensure it overrides the 'white' text rule */
    }

    .notion-editor img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
        margin: 10px 0;
        cursor: pointer;
    }

    /* --- FLOATING TOOLBAR --- */
    #floating-toolbar {
        position: absolute;
        z-index: 1000;
        background: #333;
        border-radius: 4px;
        padding: 5px;
        display: none;
        /* Hidden by default */
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        gap: 5px;
    }

    #floating-toolbar button {
        background: transparent;
        border: none;
        color: white;
        cursor: pointer;
        padding: 5px 10px;
        font-size: 0.9em;
        border-radius: 3px;
        font-weight: 600;
    }

    #floating-toolbar button:hover {
        background: #444;
    }

    #floating-toolbar::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #333 transparent transparent transparent;
    }
</style>

<div style="display: flex; justify-content: space-between; align-items: center;">
    <!-- Floating Toolbar Element -->
    <div id="floating-toolbar">
        <button id="btn-mark-code">Code &lt;/&gt;</button>
    </div>
    <div>
        <a href="{% url 'exam_detail' subject.exam.id %}" style="color: #666;">‚Üê Back to {{ subject.exam.name }}</a>
        <h1>{{ subject.name }}</h1>
    </div>
    <div style="display: flex; align-items: center; gap: 20px;">
        <div
            style="background: var(--bg-secondary); padding: 8px 15px; border-radius: 8px; font-size: 0.9em; display: flex; gap: 15px; align-items: center; border: 1px solid var(--border-color);">
            <div>
                <strong>Today:</strong> <span id="today-minutes">{{ today_minutes }}</span> / <strong>Goal:</strong> {{
                daily_goal }}m
            </div>
            <form action="{% url 'set_daily_goal' subject.id %}" method="post"
                style="display: flex; gap: 5px; align-items: center; margin: 0;">
                {% csrf_token %}
                <input type="number" name="minutes" value="{{ daily_goal }}" style="width: 60px; padding: 4px;" min="0">
                <button type="submit" class="btn btn-primary btn-sm"
                    style="padding: 4px 8px; font-size: 0.8em;">Set</button>
            </form>
        </div>

        <div class="progress-circle" style="--progress: {{ progress }}deg; width: 60px; height: 60px;">
            <div class="progress-inner" style="width: 50px; height: 50px; font-size: 12px;">
                {{ completed }} / {{ total }}
            </div>
        </div>
    </div>
</div>

{% if videos.count == 0 %}
<div class="card" style="margin-bottom: 20px; background: #fff8c4;">
    <h3>Import Playlist</h3>
    <form action="{% url 'add_playlist' subject.id %}" method="post">
        {% csrf_token %}
        <input type="text" name="playlist_url" placeholder="Paste YouTube Playlist URL" required>
        <button type="submit" class="btn btn-primary" style="margin-top: 10px;">Import Videos</button>
    </form>
</div>
{% endif %}

<div class="split-view">
    <!-- Left: Video Player & List -->
    <div class="video-section" id="video-section">
        <table>
            <thead>
                <tr>
                    <th style="width: 50px;">#</th>
                    <th>Title</th>
                    <th style="width: 100px;">Duration</th>
                    <th style="width: 80px;">Action</th>
                    <th style="width: 50px;">Done</th>
                </tr>
            </thead>
            <tbody>
                {% for video in videos %}
                <tr class="{% if video.is_watched %}watched{% endif %}">
                    <td>{{ forloop.counter }}</td>
                    <td>{{ video.title }}</td>
                    <td style="color: #666; font-size: 0.9em;">{{ video.duration_display }}</td>
                    <td>
                        <a href="https://www.youtube.com/watch?v={{ video.video_id }}" target="_blank"
                            class="btn btn-sm btn-primary">Watch on YouTube</a>
                    </td>
                    <td>
                        <input type="checkbox" onchange="toggleWatched('{{ video.id }}', this)" {% if video.is_watched %}checked{% endif %}>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Drag Gutter -->
    <div id="drag-gutter" class="gutter"></div>

    <!-- Right: Notes -->
    <div class="notes-section" id="notes-section">
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center;">
            <div class="note-toggle-container">
                <button id="btn-content" class="note-toggle-btn active" onclick="switchNoteType('content')">ChatGPT
                    Response</button>
                <button id="btn-screenshots" class="note-toggle-btn" onclick="switchNoteType('screenshots')">Lecture
                    Screenshots</button>
            </div>

            <div style="display:flex; gap:10px;">
                <select id="fontSizeSelect" class="btn" onchange="changeFontSize(this.value)"
                    style="padding: 2px 10px; cursor: pointer;">
                    <option value="" disabled selected>Size</option>
                    <option value="12px">12px</option>
                    <option value="14px">14px</option>
                    <option value="16px">16px</option>
                    <option value="18px">18px</option>
                </select>

                <button class="btn" onclick="downloadPDF()">Export PDF</button>
            </div>
        </div>

        <!-- Editable Divs (Double) -->
        <div id="editor-content" class="notion-editor active-editor" contenteditable="true"
            placeholder="Paste ChatGPT notes here (Supports Markdown Code Blocks)..."></div>

        <div id="editor-screenshots" class="notion-editor" contenteditable="true"
            placeholder="Paste lecture screenshots here..."></div>

        <div style="text-align: right; margin-top: 5px;">
            <button class="btn btn-primary" onclick="saveNotes()">Save Notes</button>
        </div>
    </div>
</div>

<script>
    console.log("===== SUBJECT_DETAIL.HTML SCRIPT LOADED =====");
    console.log("YT API available?", typeof YT !== 'undefined');

    const noteId = "{{ note.id }}";
    let activeNoteType = 'content'; // 'content' or 'screenshots'

    // Initial Load - Content Injection
    document.getElementById('editor-content').innerHTML = `{{ note.content|escapejs }}`;
    document.getElementById('editor-screenshots').innerHTML = `{{ note.content_screenshots|escapejs }}`;

    function highlightAll() {
        document.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
        });
    }
    highlightAll();

    function switchNoteType(type) {
        activeNoteType = type;
        document.querySelectorAll('.note-toggle-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-${type}`).classList.add('active');
        document.querySelectorAll('.notion-editor').forEach(ed => ed.classList.remove('active-editor'));
        document.getElementById(`editor-${type}`).classList.add('active-editor');
    }

    function saveNotes() {
        const editorFn = activeNoteType === 'content' ? 'editor-content' : 'editor-screenshots';
        const content = document.getElementById(editorFn).innerHTML;

        fetch(`/core/note/${noteId}/save/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                content: content,
                note_type: activeNoteType
            })
        }).then(() => {
            alert('Notes Saved!');
        });

    }

    // --- FLOATING TOOLBAR LOGIC ---
    const toolbar = document.getElementById('floating-toolbar');
    const markCodeBtn = document.getElementById('btn-mark-code');

    function updateToolbarPosition() {
        const selection = window.getSelection();
        if (selection.rangeCount === 0 || selection.isCollapsed) {
            toolbar.style.display = 'none';
            return;
        }

        const range = selection.getRangeAt(0);
        // Only show if selection is within an active editor
        const activeEditor = document.querySelector('.notion-editor.active-editor');
        if (!activeEditor || !activeEditor.contains(range.commonAncestorContainer)) {
            toolbar.style.display = 'none';
            return;
        }

        const rect = range.getBoundingClientRect();

        // Position above the selection
        toolbar.style.top = `${rect.top + window.scrollY - 40}px`;
        toolbar.style.left = `${rect.left + window.scrollX + (rect.width / 2) - (toolbar.offsetWidth / 2)}px`;
        toolbar.style.display = 'flex';
    }

    // specific events to trigger toolbar update
    document.addEventListener('mouseup', updateToolbarPosition);
    document.addEventListener('keyup', (e) => {
        if (e.key === 'Shift' || e.key.startsWith('Arrow')) {
            updateToolbarPosition();
        }
    });

    // Hide on click elsewhere
    document.addEventListener('mousedown', (e) => {
        if (!toolbar.contains(e.target)) {
            // Let the mouseup event handle showing it again if a new selection is made
            // But if we just click empty space, we want to hide it.
            // We'll rely on the fact that if a click clears selection, mouseup `selection.isCollapsed` will hide it.
        }
    });

    markCodeBtn.addEventListener('click', (e) => {
        e.preventDefault(); // Prevent losing focus
        const selection = window.getSelection();
        if (!selection.rangeCount) return;

        const range = selection.getRangeAt(0);
        const text = range.toString();

        if (text) {
            // Create the code block structure
            // Use <pre><code ...>...</code></pre>
            // We use a temporary container to facilitate insertion
            const pre = document.createElement('pre');
            const code = document.createElement('code');
            code.textContent = text; // Safely escape HTML
            pre.appendChild(code);

            range.deleteContents();
            range.insertNode(pre);

            // Highlight it immediately
            hljs.highlightElement(code);

            // Clean up: hide toolbar
            toolbar.style.display = 'none';
            window.getSelection().removeAllRanges();
        }
    });

    // Check & Highlight on Blur
    document.querySelectorAll('.notion-editor').forEach(editor => {
        editor.addEventListener('blur', function () {
            // Apply highlight to any PRE blocks that exist
            editor.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        });

        // Sanitize paste styles
        editor.addEventListener('paste', function (e) {
            setTimeout(() => {
                editor.querySelectorAll('div, p, span').forEach(el => {
                    // Remove white backgrounds from paste
                    if (el.style.backgroundColor === 'rgb(255, 255, 255)' || el.style.backgroundColor === '#ffffff') {
                        el.style.backgroundColor = '';
                    }
                    if (el.style.color === 'rgb(0, 0, 0)') {
                        el.style.color = '';
                    }
                });
            }, 100);
        });
    });

    // --- Helper Functions ---
    if (window.MathJax) {
        MathJax.typesetPromise([document.getElementById('editor-content')]).then(() => { });
        MathJax.typesetPromise([document.getElementById('editor-screenshots')]).then(() => { });
    }

    function changeFontSize(size) {
        if (!size) return;
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0 || selection.isCollapsed) return;
        const span = document.createElement("span");
        span.style.fontSize = size;
        try {
            const range = selection.getRangeAt(0);
            const content = range.extractContents();
            span.appendChild(content);
            range.insertNode(span);
        } catch (e) { console.error(e); }
        document.getElementById('fontSizeSelect').selectedIndex = 0;
    }

    // Global reference for the player


    function toggleWatched(videoId, checkbox) {
        fetch(`/core/video/${videoId}/status/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ is_watched: checkbox.checked })
        }).then(r => r.json()).then(data => {
            if (data.today_minutes !== undefined) document.getElementById('today-minutes').innerText = data.today_minutes;
        });
    }

    /* UPDATED PDF EXPORT */
    function downloadPDF() {
        var printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>Notes Export</title>');

        // 1. Inject Highlight.js CSS for PDF
        printWindow.document.write('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">');

        printWindow.document.write('<style>');
        printWindow.document.write(`
            @media print {
                @page {
                    margin-bottom: 2cm;
                    @bottom-center {
                        content: "Page " counter(page);
                        font-size: 10pt;
                        color: #555;
                    }
                }
                body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                pre { background-color: #1E1E1E !important; color: #dcdcdc !important; }
            }
            body { font-family: sans-serif; padding: 40px; background: white; color: black; }
            /* Explicitly dark code blocks for print */
            pre { 
                background: #1E1E1E !important; 
                border-radius: 6px; 
                padding: 1em; 
                margin: 1em 0; 
                white-space: pre-wrap; 
                color: #dcdcdc;
            }
            code { font-family: monospace; }
            img { max-width:100%; }
        `);
        printWindow.document.write('</style>');

        printWindow.document.write('</head><body>');
        printWindow.document.write('<h1>{{ subject.name|escapejs }} Notes (' + (activeNoteType === 'content' ? 'Theory' : 'Screenshots') + ')</h1>');
        printWindow.document.write(document.querySelector('.notion-editor.active-editor').innerHTML);
        printWindow.document.write('</body></html>');
        printWindow.document.close();

        // Delay to allow CSS to load
        setTimeout(() => { printWindow.print(); }, 1500);
    }

    // Split View
    document.addEventListener('DOMContentLoaded', function () {
        const gutter = document.getElementById('drag-gutter');
        const videoSection = document.getElementById('video-section');
        const notesSection = document.getElementById('notes-section');
        const container = videoSection.parentElement;
        let isDragging = false;

        gutter.addEventListener('mousedown', function (e) {
            isDragging = true;
            document.body.style.cursor = 'col-resize';
            // Disable pointer events on iframes to prevent mouse capture
            document.querySelectorAll('iframe').forEach(iframe => iframe.style.pointerEvents = 'none');
        });

        document.addEventListener('mousemove', function (e) {
            if (!isDragging) return;
            e.preventDefault(); // Prevent text selection
            const containerRect = container.getBoundingClientRect();
            let newVideoWidth = e.clientX - containerRect.left - (gutter.offsetWidth / 2);
            if (newVideoWidth < 200) newVideoWidth = 200;
            if (newVideoWidth > containerRect.width - 200) newVideoWidth = containerRect.width - 200;
            videoSection.style.flex = `0 0 ${newVideoWidth}px`;
            notesSection.style.flex = `1 1 auto`;
        });

        document.addEventListener('mouseup', function (e) {
            if (isDragging) {
                isDragging = false;
                document.body.style.cursor = 'default';
                // Re-enable pointer events on iframes
                document.querySelectorAll('iframe').forEach(iframe => iframe.style.pointerEvents = 'auto');
            }
        });
    });
</script>
{% endblock %}