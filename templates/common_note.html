{% extends 'base.html' %}

{% block content %}
<!-- Highlight.js (VS Code Dark) & Marked.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<div class="notes-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Common Notes</h1>
        <div style="display:flex; gap:10px;">
            <button class="btn" onclick="formatDoc('bold')" title="Bold"><b>B</b></button>
            <button class="btn" onclick="formatDoc('italic')" title="Italic"><i>I</i></button>

            <select id="fontSizeSelect" class="btn" onchange="changeFontSize(this.value)"
                style="padding: 2px 10px; cursor: pointer;">
                <option value="" disabled selected>Size</option>
                <option value="12px">12px</option>
                <option value="14px">14px</option>
                <option value="16px">16px</option>
                <option value="18px">18px</option>
                <option value="20px">20px</option>
                <option value="24px">24px</option>
                <option value="30px">30px</option>
            </select>
            <button class="btn" onclick="downloadPDF()">Export PDF</button>
        </div>
    </div>

    <!-- Editable Div -->
    <div id="editor" class="notion-editor active-editor" contenteditable="true"
        placeholder="Type here or paste ChatGPT response with Markdown/LaTeX..." style="display: block !important;">
    </div>

    <div style="text-align: right; margin-top: 15px;">
        <button class="btn btn-primary" onclick="saveNotes()">Save Notes</button>
    </div>
</div>

<script>
    // Initial Load
    const initialContent = `{{ note.content|escapejs }}`;
    const editor = document.getElementById('editor');
    editor.innerHTML = initialContent;

    // Trigger math render on load
    if (window.MathJax) {
        MathJax.typesetPromise([editor]).then(() => {
            document.querySelectorAll('mjx-container').forEach(el => el.removeAttribute('tabindex'));
        });
    }

    // Highlight Code Blocks
    document.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
    });

    function formatDoc(cmd, value = null) {
        document.execCommand(cmd, false, value);
        editor.focus();
    }

    function changeFontSize(size) {
        if (!size) return;
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0 || selection.isCollapsed) {
            alert("Please select some text first.");
            return;
        }
        const span = document.createElement("span");
        span.style.fontSize = size;
        try {
            const range = selection.getRangeAt(0);
            const content = range.extractContents();
            span.appendChild(content);
            range.insertNode(span);
        } catch (e) {
            console.error(e);
        }
        document.getElementById('fontSizeSelect').selectedIndex = 0;
    }

    function saveNotes() {
        const content = editor.innerHTML;
        fetch("{% url 'save_common_note' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ content: content })
        }).then(() => {
            alert('Common Notes Saved!');
        });
    }

    // --- PASTE LOGIC (Critical Fix) ---
    editor.addEventListener('paste', function (e) {
        e.preventDefault();
        var text = (e.originalEvent || e).clipboardData.getData('text/plain');
        document.execCommand('insertText', false, text);

        // Auto-sanitize after paste
        setTimeout(() => sanitizeEditor(editor), 50);
    });

    // --- SANITIZE LOGIC ---
    function sanitizeEditor(editorElement) {
        if (!editorElement) return;
        editorElement.querySelectorAll('*').forEach(el => {
            // Remove fixed font sizes/colors/backgrounds
            if (el.style.fontSize) el.style.fontSize = '';
            if (el.style.backgroundColor) el.style.backgroundColor = '';
            if (el.style.color) el.style.color = '';
            el.removeAttribute('data-font-size');
        });
    }

    function downloadPDF() {
        var printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>Common Notes Export</title>');
        // Inject Highlight.js CSS
        printWindow.document.write('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">');

        printWindow.document.write('<style>');
        printWindow.document.write(`
            @media print {
                body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                pre { background-color: #1E1E1E !important; color: #dcdcdc !important; }
            }
            body { font-family: sans-serif; padding: 40px; } 
            img { max-width:100%; }
            pre { background: #1E1E1E !important; border-radius: 6px; padding: 1em; color: #dcdcdc; white-space: pre-wrap; }
        `);
        printWindow.document.write('</style>');

        printWindow.document.write('<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>');
        printWindow.document.write('</head><body>');
        printWindow.document.write('<h1>Common Notes</h1>');
        printWindow.document.write(editor.innerHTML);
        printWindow.document.write('</body></html>');
        printWindow.document.close();

        setTimeout(() => {
            printWindow.print();
        }, 1500);
    }
</script>
{% endblock %}